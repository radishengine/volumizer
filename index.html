<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <title>Volumizer</title>
    <script src='VolumizerClient.js'></script>
    <style>
      body {
        font-family: sans-serif;
      }
      #dropzone {
        display: none;
        position: fixed;
        z-order: 1000;
        background: rgba(255, 255, 255, 0.5);
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        padding: 30px;
      }
      .drop-border {
        border: 10px dashed silver;
        height: 100%;
      }
      body.dropping > #dropzone {
        display: block;
      }
    </style>
  </head>
  <body>
    <div id='dropzone'>
      <div class='drop-border'></div>
    </div>
    <script>
      
      var blobVC = null;
      var vc = null;
      
      function onFile(file) {
        var structure = [];
        if (/\.(?:iso|dsk|img|image|toast|cdr)/i.test(file.name)) {
          structure.push('mac/partitioned', 'mac/hfs', 'mac/mfs');
        }
        if (structure.length === 0) {
          alert('unrecognized file type');
          return;
        }
        if (!blobVC) {
          blobVC = new VolumizerClient;
        }
        var vc = blobVC;
        document.body.classList.remove('cancelled', 'error');
        document.body.classList.add('loading');
        vc.task(
          {
            headline: 'volumize',
            source: file,
            sectors: [{offset:0, length:file.size}],
            structure: structure,
          },
          {
            onentry: function(entry) {
              console.dir(entry);
            },
          }
        ).then(
          function() {
            document.body.classList.remove('loading');
          },
          function() {
            document.body.classList.remove('loading');
            document.body.classList.add('error');
          }
        );
      }
      
      document.body.dragEnterCount = 0;
      
      document.body.ondragenter = function(e) {
        e.preventDefault();
        if (++document.body.dragEnterCount === 1) {
          e.dataTransfer.dropEffect = 'copy';
          document.body.classList.add('dropping');
        }
      };

      document.documentElement.ondragenter = function(e) {
        e.preventDefault();
        document.body.classList.add('dropping');
      };
      document.body.ondragleave = function(e) {
        e.preventDefault();
        if (--document.body.dragEnterCount === 0) {
          document.body.classList.remove('dropping');
        }
      };
      document.body.ondragover = function(e) {
        e.preventDefault();
      }
      document.body.ondragend = function(e) {
        e.preventDefault();
        document.body.classList.remove('dropping');
      };
      document.body.ondrop = function(e) {
        e.preventDefault();
        document.body.classList.remove('dropping');
        var file = e.dataTransfer.files && e.dataTransfer.files[0];
        if (file) {
          if (/^#?(upload:|$)/.test(location.hash)) {
            history.replaceState(undefined, undefined, '#upload:' + file.name);
          }
          else {
            history.pushState(undefined, undefined, '#upload:' + file.name);
          }
          onFile(file);
        }
      };
      
      window.onkeydown = function(e) {
        if (e.keyCode === 27) {
          if (vc) {
            vc.close();
            vc = null;
            document.body.classList.add('cancelled');
          }
        }
      };
      
    </script>
  </body>
</html>
